import { Component, EventEmitter, Input, Output, ViewChild } from '@angular/core';
import { Dropdown } from 'primeng/dropdown';
import { MODE } from '../constants';
import { ProvenanceWidgetsService } from '../provenance-widgets.service';
import isEqual from 'lodash.isequal';
import * as i0 from "@angular/core";
import * as i1 from "../provenance-widgets.service";
import * as i2 from "primeng/api";
import * as i3 from "@angular/common";
import * as i4 from "@angular-slider/ngx-slider";
import * as i5 from "primeng/button";
import * as i6 from "@angular/forms";
import * as i7 from "primeng/dropdown";
import * as i8 from "../icon/icon.component";
export class DropdownComponent extends Dropdown {
    get selected() {
        return this._selected;
    }
    set selected(value) {
        if (!this.firstChange && !isEqual(this._selected, value)) {
            this.handleChange({ originalEvent: new Event("provenance"), value });
        }
        this.firstChange = false;
        this._selected = value;
    }
    get provenance() {
        return this._provenance;
    }
    set provenance(value) {
        if (this._provenance && value?.revalidate) {
            this._provenance = value;
            this.ngOnInit();
            this._visualize();
        }
        this._provenance = value;
    }
    constructor(mss, el, renderer, cd, zone, filterService, config) {
        super(el, renderer, cd, zone, filterService, config);
        this.mss = mss;
        this.firstChange = true;
        this.mode = MODE;
        this.visualize = true;
        this.selectedChange = new EventEmitter();
        this.interval = NaN;
        this.optionsRecord = {};
        this.myOverlayOptions = {
            'appendTo': 'body',
            hideOnEscape: false,
            ...this.overlayOptions
        };
        this.freeze = false;
        this.provenanceChange = new EventEmitter();
        mss.init(el, ".panel" + this.mss.myId + " > div > ul", "select");
        mss.crosshairSelect = (keys) => {
            this.selectedChange.emit(this.optionsRecord[keys[0]]);
        };
    }
    ngOnInit() {
        super.ngOnInit();
        this.mss.options = this.options.length;
        this.mss.mode = this.mode;
        this.options.forEach((option) => {
            this.optionsRecord[option[this.dataKey]] = option;
        });
        if (this.provenance?.hasUserInteracted || this.provenance?.revalidate) {
            this.mss.setProvenance(this.provenance);
            this.selected = Object
                .entries(this.mss.getProvenance().dataByOption)
                .filter(([_, v]) => {
                const last = v.at(-1);
                return last && last.unselect === undefined && last.select !== undefined;
            })
                .map(([k, _]) => this.optionsRecord[k])[0];
            return;
        }
        if (this.selected) {
            this.mss.addSimultaneousEvents([], [this.selected[this.dataKey]], this.freeze, false);
        }
    }
    ngAfterViewInit() {
        this.mss.setElement(this.el);
        super.ngAfterViewInit();
        if (this.mss.getProvenance()?.hasUserInteracted)
            this._visualize();
    }
    getProvenance() {
        return this.mss;
    }
    getId() {
        return this.mss.myId;
    }
    handleClick(btn) {
        this.mss.toggleProvenanceMode(btn, false);
        setTimeout(() => this.pDropdown.show(), this.pDropdown.overlayVisible ? 1000 : 0);
    }
    handleChange(e) {
        this.mss.addSimultaneousEvents(this.selected ? [this.selected[this.dataKey]] : [], e.value ? [e.value[this.dataKey]] : [], this.freeze, true, new Date(), this.provenanceChange, this._visualize.bind(this));
    }
    handleFilter(event) {
        this.onFilter?.emit(event);
        const timeout = event.filter ? 0 : 100;
        setTimeout(() => this._visualize(), timeout);
    }
    toggleShow(e) {
        this[this.overlayVisible ? 'onHide' : 'onShow']?.emit(e);
        this.overlayVisible = !this.overlayVisible;
        this._visualize();
    }
    _visualize() {
        if (!this.visualize || !this.overlayVisible)
            return;
        let li = undefined;
        for (const option of this.options) {
            const div = document.getElementById(this.mss.myId + option[this.dataKey] + 'div');
            if (div && div.parentElement) {
                li = div.parentElement;
                break;
            }
        }
        if (!li)
            return;
        const offsetWidth = li.offsetWidth - 40;
        const offsetHeight = li.offsetHeight - 24;
        this.mss.visualize(this.mode, offsetWidth, offsetHeight);
    }
}
DropdownComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.10", ngImport: i0, type: DropdownComponent, deps: [{ token: i1.ProvenanceWidgetsService }, { token: i0.ElementRef }, { token: i0.Renderer2 }, { token: i0.ChangeDetectorRef }, { token: i0.NgZone }, { token: i2.FilterService }, { token: i2.PrimeNGConfig }], target: i0.ɵɵFactoryTarget.Component });
DropdownComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "15.2.10", type: DropdownComponent, selector: "provenance-dropdown", inputs: { mode: "mode", selected: "selected", iconSize: "iconSize", visualize: "visualize", provenance: "provenance", freeze: "freeze" }, outputs: { selectedChange: "selectedChange", provenanceChange: "provenanceChange" }, providers: [ProvenanceWidgetsService], viewQueries: [{ propertyName: "pDropdown", first: true, predicate: ["pDropdown"], descendants: true }], usesInheritance: true, ngImport: i0, template: "<div class=\"p-inputgroup flex flex-row gap-3\">\n    <button\n        *ngIf=\"visualize\"\n        pButton\n        type=\"button\"\n        class=\"p-button-help p-button-text\"\n        [disabled]=\"!getProvenance().hasUserInteracted\"\n        [ngStyle]=\"{ 'padding': 0, 'align-self': 'center', 'height': 'min-content', 'visibility': visualize ? 'visible' : 'hidden'}\"\n        #btn\n        (click)=\"handleClick(btn)\"\n    >\n        <provenance-icon\n            [icon]=\"!getProvenance().hasUserInteracted ? 'disabled' : getProvenance().provenanceMode\"\n            [size]=\"iconSize\"\n        ></provenance-icon>\n    </button>\n    <p-dropdown\n        #pDropdown\n        [scrollHeight]=\"scrollHeight\"\n        [filter]=\"filter\"\n        [name]=\"name\"\n        [style]=\"style\"\n        [panelStyle]=\"panelStyle\"\n        [styleClass]=\"(styleClass || '') + ' provenance-dropdown'\"\n        [panelStyleClass]=\"(panelStyleClass || '') + 'provenance-dropdown-panel panel' + this.getId()\"\n        [readonly]=\"readonly\"\n        [required]=\"required\"\n        [editable]=\"editable\"\n        [appendTo]=\"appendTo\"\n        [tabindex]=\"tabindex\"\n        [placeholder]=\"placeholder\"\n        [filterPlaceholder]=\"filterPlaceholder\"\n        [filterLocale]=\"filterLocale\"\n        [inputId]=\"inputId\"\n        [selectId]=\"selectId\"\n        [dataKey]=\"dataKey\"\n        [filterBy]=\"filterBy\"\n        [autofocus]=\"autofocus\"\n        [resetFilterOnHide]=\"resetFilterOnHide\"\n        [dropdownIcon]=\"dropdownIcon\"\n        [optionLabel]=\"optionLabel\"\n        [optionValue]=\"optionValue\"\n        [optionDisabled]=\"optionDisabled\"\n        [optionGroupLabel]=\"optionGroupLabel\"\n        [optionGroupChildren]=\"optionGroupChildren\"\n        [autoDisplayFirst]=\"autoDisplayFirst\"\n        [group]=\"group\"\n        [showClear]=\"showClear\"\n        [emptyFilterMessage]=\"emptyFilterMessage\"\n        [emptyMessage]=\"emptyMessage\"\n        [lazy]=\"lazy\"\n        [virtualScroll]=\"virtualScroll\"\n        [virtualScrollItemSize]=\"virtualScrollItemSize\"\n        [virtualScrollOptions]=\"virtualScrollOptions\"\n        [overlayOptions]=\"myOverlayOptions\"\n        [ariaFilterLabel]=\"ariaFilterLabel\"\n        [ariaLabel]=\"ariaLabel\"\n        [ariaLabelledBy]=\"ariaLabelledBy\"\n        [filterMatchMode]=\"filterMatchMode\"\n        [maxlength]=\"maxlength\"\n        [tooltip]=\"tooltip\"\n        [tooltipPosition]=\"tooltipPosition\"\n        [tooltipPositionStyle]=\"tooltipPositionStyle\"\n        [tooltipStyleClass]=\"tooltipStyleClass\"\n        [autofocusFilter]=\"autofocusFilter\"\n        [overlayDirection]=\"overlayDirection\"\n        [disabled]=\"disabled\"\n        [itemSize]=\"itemSize\"\n        [autoZIndex]=\"autoZIndex\"\n        [baseZIndex]=\"baseZIndex\"\n        [showTransitionOptions]=\"showTransitionOptions\"\n        [hideTransitionOptions]=\"hideTransitionOptions\"\n        [options]=\"options\"\n        [filterValue]=\"filterValue\"\n        (onChange)=\"onChange\"\n        (onFilter)=\"handleFilter($event)\"\n        (onFocus)=\"onFocus\"\n        (onBlur)=\"onBlur\"\n        (onClick)=\"onClick\"\n        (onShow)=\"toggleShow($event)\"\n        (onHide)=\"toggleShow($event)\"\n        (onClear)=\"onClear\"\n        (onLazyLoad)=\"onLazyLoad\"\n        (ngModelChange)=\"this.getProvenance().interaction = 'user-change'; selectedChange.emit($event)\"\n        [ngModel]=\"selected\"\n    >\n        <ng-template let-option pTemplate=\"item\">\n            <div style=\"position: relative; width: 100%;\" [id]=\"getId() + option[dataKey] + 'div'\">\n                <svg \n                  [id]=\"getId() + option[dataKey]\" \n                  width=\"0\" \n                  height=\"0\"\n                  [style]=\"{ 'position': 'absolute', 'display': getProvenance().hasUserInteracted ? 'initial' : 'none' }\"\n                ></svg>\n                <div style=\"display: flex; justify-content: space-between; position: inherit;\">\n                    <span>\n                        {{ option[optionLabel] }}\n                    </span>\n                </div>\n            </div>\n        </ng-template>\n        <ng-template pTemplate=\"footer\">\n            <div class=\"custom-slider temporal-slider\">\n                <ngx-slider\n                    *ngIf=\"getProvenance().provenanceMode === 'temporal'\"\n                    [value]=\"getProvenance().temporalFilterRange[0]\"\n                    [highValue]=\"getProvenance().temporalFilterRange[1]\"\n                    [options]=\"getProvenance().temporalOptions\"\n                    (userChangeEnd)=\"getProvenance().setTemporalRange($event)\"\n                ></ngx-slider>\n            </div>\n        </ng-template>\n    </p-dropdown>\n</div>\n", styles: ["::ng-deep div.provenance-dropdown-panel>div>ul{position:relative}::ng-deep div.provenance-dropdown-panel>div.temporal-slider{padding-right:1.25rem;padding-left:1.25rem}::ng-deep .provenance-dropdown{width:initial!important}\n", "::ng-deep .custom-slider .ngx-slider .ngx-slider-bar{background:lightgray;height:3px}::ng-deep .custom-slider .ngx-slider .ngx-slider-selection{background:var(--blue-500)}::ng-deep .custom-slider .ngx-slider .ngx-slider-pointer{width:8px;height:16px;top:auto;bottom:0;background-color:#333;border-top-left-radius:3px;border-top-right-radius:3px}::ng-deep .custom-slider .ngx-slider .ngx-slider-pointer:after{display:none}::ng-deep .custom-slider:not(.temporal-slider) .ngx-slider .ngx-slider-bubble{top:5px}::ng-deep .custom-slider .ngx-slider .ngx-slider-limit{font-weight:700;color:var(--blue-500)}::ng-deep .custom-slider .ngx-slider .ngx-slider-tick{width:1px;height:10px;margin-left:4px;border-radius:0;background:#ffe4d1;top:-1px}::ng-deep .custom-slider .ngx-slider .ngx-slider-tick.ngx-slider-selected{background:var(--blue-500)}::ng-deep g.axis text{font-size:.7rem}::ng-deep .custom-slider span{margin-top:0!important;padding-top:0!important}\n"], dependencies: [{ kind: "directive", type: i3.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { kind: "directive", type: i3.NgStyle, selector: "[ngStyle]", inputs: ["ngStyle"] }, { kind: "component", type: i4.SliderComponent, selector: "ngx-slider", inputs: ["value", "highValue", "options", "manualRefresh", "triggerFocus"], outputs: ["valueChange", "highValueChange", "userChangeStart", "userChange", "userChangeEnd"] }, { kind: "directive", type: i2.PrimeTemplate, selector: "[pTemplate]", inputs: ["type", "pTemplate"] }, { kind: "directive", type: i5.ButtonDirective, selector: "[pButton]", inputs: ["iconPos", "loadingIcon", "label", "icon", "loading"] }, { kind: "directive", type: i6.NgControlStatus, selector: "[formControlName],[ngModel],[formControl]" }, { kind: "directive", type: i6.RequiredValidator, selector: ":not([type=checkbox])[required][formControlName],:not([type=checkbox])[required][formControl],:not([type=checkbox])[required][ngModel]", inputs: ["required"] }, { kind: "directive", type: i6.MaxLengthValidator, selector: "[maxlength][formControlName],[maxlength][formControl],[maxlength][ngModel]", inputs: ["maxlength"] }, { kind: "directive", type: i6.NgModel, selector: "[ngModel]:not([formControlName]):not([formControl])", inputs: ["name", "disabled", "ngModel", "ngModelOptions"], outputs: ["ngModelChange"], exportAs: ["ngModel"] }, { kind: "component", type: i7.Dropdown, selector: "p-dropdown", inputs: ["scrollHeight", "filter", "name", "style", "panelStyle", "styleClass", "panelStyleClass", "readonly", "required", "editable", "appendTo", "tabindex", "placeholder", "filterPlaceholder", "filterLocale", "inputId", "selectId", "dataKey", "filterBy", "autofocus", "resetFilterOnHide", "dropdownIcon", "optionLabel", "optionValue", "optionDisabled", "optionGroupLabel", "optionGroupChildren", "autoDisplayFirst", "group", "showClear", "emptyFilterMessage", "emptyMessage", "lazy", "virtualScroll", "virtualScrollItemSize", "virtualScrollOptions", "overlayOptions", "ariaFilterLabel", "ariaLabel", "ariaLabelledBy", "filterMatchMode", "maxlength", "tooltip", "tooltipPosition", "tooltipPositionStyle", "tooltipStyleClass", "autofocusFilter", "overlayDirection", "disabled", "itemSize", "autoZIndex", "baseZIndex", "showTransitionOptions", "hideTransitionOptions", "options", "filterValue"], outputs: ["onChange", "onFilter", "onFocus", "onBlur", "onClick", "onShow", "onHide", "onClear", "onLazyLoad"] }, { kind: "component", type: i8.IconComponent, selector: "provenance-icon", inputs: ["icon", "size"] }] });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.10", ngImport: i0, type: DropdownComponent, decorators: [{
            type: Component,
            args: [{ selector: 'provenance-dropdown', providers: [ProvenanceWidgetsService], template: "<div class=\"p-inputgroup flex flex-row gap-3\">\n    <button\n        *ngIf=\"visualize\"\n        pButton\n        type=\"button\"\n        class=\"p-button-help p-button-text\"\n        [disabled]=\"!getProvenance().hasUserInteracted\"\n        [ngStyle]=\"{ 'padding': 0, 'align-self': 'center', 'height': 'min-content', 'visibility': visualize ? 'visible' : 'hidden'}\"\n        #btn\n        (click)=\"handleClick(btn)\"\n    >\n        <provenance-icon\n            [icon]=\"!getProvenance().hasUserInteracted ? 'disabled' : getProvenance().provenanceMode\"\n            [size]=\"iconSize\"\n        ></provenance-icon>\n    </button>\n    <p-dropdown\n        #pDropdown\n        [scrollHeight]=\"scrollHeight\"\n        [filter]=\"filter\"\n        [name]=\"name\"\n        [style]=\"style\"\n        [panelStyle]=\"panelStyle\"\n        [styleClass]=\"(styleClass || '') + ' provenance-dropdown'\"\n        [panelStyleClass]=\"(panelStyleClass || '') + 'provenance-dropdown-panel panel' + this.getId()\"\n        [readonly]=\"readonly\"\n        [required]=\"required\"\n        [editable]=\"editable\"\n        [appendTo]=\"appendTo\"\n        [tabindex]=\"tabindex\"\n        [placeholder]=\"placeholder\"\n        [filterPlaceholder]=\"filterPlaceholder\"\n        [filterLocale]=\"filterLocale\"\n        [inputId]=\"inputId\"\n        [selectId]=\"selectId\"\n        [dataKey]=\"dataKey\"\n        [filterBy]=\"filterBy\"\n        [autofocus]=\"autofocus\"\n        [resetFilterOnHide]=\"resetFilterOnHide\"\n        [dropdownIcon]=\"dropdownIcon\"\n        [optionLabel]=\"optionLabel\"\n        [optionValue]=\"optionValue\"\n        [optionDisabled]=\"optionDisabled\"\n        [optionGroupLabel]=\"optionGroupLabel\"\n        [optionGroupChildren]=\"optionGroupChildren\"\n        [autoDisplayFirst]=\"autoDisplayFirst\"\n        [group]=\"group\"\n        [showClear]=\"showClear\"\n        [emptyFilterMessage]=\"emptyFilterMessage\"\n        [emptyMessage]=\"emptyMessage\"\n        [lazy]=\"lazy\"\n        [virtualScroll]=\"virtualScroll\"\n        [virtualScrollItemSize]=\"virtualScrollItemSize\"\n        [virtualScrollOptions]=\"virtualScrollOptions\"\n        [overlayOptions]=\"myOverlayOptions\"\n        [ariaFilterLabel]=\"ariaFilterLabel\"\n        [ariaLabel]=\"ariaLabel\"\n        [ariaLabelledBy]=\"ariaLabelledBy\"\n        [filterMatchMode]=\"filterMatchMode\"\n        [maxlength]=\"maxlength\"\n        [tooltip]=\"tooltip\"\n        [tooltipPosition]=\"tooltipPosition\"\n        [tooltipPositionStyle]=\"tooltipPositionStyle\"\n        [tooltipStyleClass]=\"tooltipStyleClass\"\n        [autofocusFilter]=\"autofocusFilter\"\n        [overlayDirection]=\"overlayDirection\"\n        [disabled]=\"disabled\"\n        [itemSize]=\"itemSize\"\n        [autoZIndex]=\"autoZIndex\"\n        [baseZIndex]=\"baseZIndex\"\n        [showTransitionOptions]=\"showTransitionOptions\"\n        [hideTransitionOptions]=\"hideTransitionOptions\"\n        [options]=\"options\"\n        [filterValue]=\"filterValue\"\n        (onChange)=\"onChange\"\n        (onFilter)=\"handleFilter($event)\"\n        (onFocus)=\"onFocus\"\n        (onBlur)=\"onBlur\"\n        (onClick)=\"onClick\"\n        (onShow)=\"toggleShow($event)\"\n        (onHide)=\"toggleShow($event)\"\n        (onClear)=\"onClear\"\n        (onLazyLoad)=\"onLazyLoad\"\n        (ngModelChange)=\"this.getProvenance().interaction = 'user-change'; selectedChange.emit($event)\"\n        [ngModel]=\"selected\"\n    >\n        <ng-template let-option pTemplate=\"item\">\n            <div style=\"position: relative; width: 100%;\" [id]=\"getId() + option[dataKey] + 'div'\">\n                <svg \n                  [id]=\"getId() + option[dataKey]\" \n                  width=\"0\" \n                  height=\"0\"\n                  [style]=\"{ 'position': 'absolute', 'display': getProvenance().hasUserInteracted ? 'initial' : 'none' }\"\n                ></svg>\n                <div style=\"display: flex; justify-content: space-between; position: inherit;\">\n                    <span>\n                        {{ option[optionLabel] }}\n                    </span>\n                </div>\n            </div>\n        </ng-template>\n        <ng-template pTemplate=\"footer\">\n            <div class=\"custom-slider temporal-slider\">\n                <ngx-slider\n                    *ngIf=\"getProvenance().provenanceMode === 'temporal'\"\n                    [value]=\"getProvenance().temporalFilterRange[0]\"\n                    [highValue]=\"getProvenance().temporalFilterRange[1]\"\n                    [options]=\"getProvenance().temporalOptions\"\n                    (userChangeEnd)=\"getProvenance().setTemporalRange($event)\"\n                ></ngx-slider>\n            </div>\n        </ng-template>\n    </p-dropdown>\n</div>\n", styles: ["::ng-deep div.provenance-dropdown-panel>div>ul{position:relative}::ng-deep div.provenance-dropdown-panel>div.temporal-slider{padding-right:1.25rem;padding-left:1.25rem}::ng-deep .provenance-dropdown{width:initial!important}\n", "::ng-deep .custom-slider .ngx-slider .ngx-slider-bar{background:lightgray;height:3px}::ng-deep .custom-slider .ngx-slider .ngx-slider-selection{background:var(--blue-500)}::ng-deep .custom-slider .ngx-slider .ngx-slider-pointer{width:8px;height:16px;top:auto;bottom:0;background-color:#333;border-top-left-radius:3px;border-top-right-radius:3px}::ng-deep .custom-slider .ngx-slider .ngx-slider-pointer:after{display:none}::ng-deep .custom-slider:not(.temporal-slider) .ngx-slider .ngx-slider-bubble{top:5px}::ng-deep .custom-slider .ngx-slider .ngx-slider-limit{font-weight:700;color:var(--blue-500)}::ng-deep .custom-slider .ngx-slider .ngx-slider-tick{width:1px;height:10px;margin-left:4px;border-radius:0;background:#ffe4d1;top:-1px}::ng-deep .custom-slider .ngx-slider .ngx-slider-tick.ngx-slider-selected{background:var(--blue-500)}::ng-deep g.axis text{font-size:.7rem}::ng-deep .custom-slider span{margin-top:0!important;padding-top:0!important}\n"] }]
        }], ctorParameters: function () { return [{ type: i1.ProvenanceWidgetsService }, { type: i0.ElementRef }, { type: i0.Renderer2 }, { type: i0.ChangeDetectorRef }, { type: i0.NgZone }, { type: i2.FilterService }, { type: i2.PrimeNGConfig }]; }, propDecorators: { mode: [{
                type: Input
            }], selected: [{
                type: Input
            }], iconSize: [{
                type: Input
            }], visualize: [{
                type: Input
            }], selectedChange: [{
                type: Output
            }], pDropdown: [{
                type: ViewChild,
                args: ["pDropdown"]
            }], provenance: [{
                type: Input
            }], freeze: [{
                type: Input
            }], provenanceChange: [{
                type: Output
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHJvcGRvd24uY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvcHJvdmVuYW5jZS13aWRnZXRzL3NyYy9saWIvZHJvcGRvd24vZHJvcGRvd24uY29tcG9uZW50LnRzIiwiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvcHJvdmVuYW5jZS13aWRnZXRzL3NyYy9saWIvZHJvcGRvd24vZHJvcGRvd24uY29tcG9uZW50Lmh0bWwiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFvQyxTQUFTLEVBQWMsWUFBWSxFQUFFLEtBQUssRUFBVSxNQUFNLEVBQWEsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRW5KLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUM1QyxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQ3BDLE9BQU8sRUFBRSx3QkFBd0IsRUFBYyxNQUFNLCtCQUErQixDQUFDO0FBQ3JGLE9BQU8sT0FBTyxNQUFNLGdCQUFnQixDQUFDOzs7Ozs7Ozs7O0FBYXJDLE1BQU0sT0FBTyxpQkFBa0IsU0FBUSxRQUFRO0lBRzdDLElBQ0ksUUFBUTtRQUNWLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQTtJQUN2QixDQUFDO0lBQ0QsSUFBSSxRQUFRLENBQUMsS0FBSztRQUNoQixJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLEtBQUssQ0FBQyxFQUFFO1lBQ3hELElBQUksQ0FBQyxZQUFZLENBQUMsRUFBRSxhQUFhLEVBQUUsSUFBSSxLQUFLLENBQUMsWUFBWSxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQTtTQUNyRTtRQUNELElBQUksQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFBO1FBQ3hCLElBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFBO0lBQ3hCLENBQUM7SUFhRCxJQUNJLFVBQVU7UUFDWixPQUFPLElBQUksQ0FBQyxXQUFXLENBQUE7SUFDekIsQ0FBQztJQUNELElBQUksVUFBVSxDQUFDLEtBQUs7UUFDbEIsSUFBSSxJQUFJLENBQUMsV0FBVyxJQUFJLEtBQUssRUFBRSxVQUFVLEVBQUU7WUFDekMsSUFBSSxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUE7WUFDeEIsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFBO1lBQ2YsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFBO1NBQ2xCO1FBQ0QsSUFBSSxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUE7SUFDMUIsQ0FBQztJQUtELFlBQ1UsR0FBNkIsRUFDckMsRUFBbUIsRUFDbkIsUUFBbUIsRUFDbkIsRUFBcUIsRUFDckIsSUFBWSxFQUNaLGFBQTRCLEVBQzVCLE1BQXFCO1FBRXJCLEtBQUssQ0FBQyxFQUFFLEVBQUUsUUFBUSxFQUFFLEVBQUUsRUFBRSxJQUFJLEVBQUUsYUFBYSxFQUFFLE1BQU0sQ0FBQyxDQUFBO1FBUjVDLFFBQUcsR0FBSCxHQUFHLENBQTBCO1FBMUN2QyxnQkFBVyxHQUFHLElBQUksQ0FBQTtRQUNULFNBQUksR0FBRyxJQUFJLENBQUE7UUFjWCxjQUFTLEdBQUcsSUFBSSxDQUFBO1FBQ2YsbUJBQWMsR0FBRyxJQUFJLFlBQVksRUFBMEIsQ0FBQTtRQUVyRSxhQUFRLEdBQUcsR0FBRyxDQUFBO1FBQ2Qsa0JBQWEsR0FBMkMsRUFBRSxDQUFBO1FBQzFELHFCQUFnQixHQUFHO1lBQ2pCLFVBQVUsRUFBRSxNQUFlO1lBQzNCLFlBQVksRUFBRSxLQUFLO1lBQ25CLEdBQUcsSUFBSSxDQUFDLGNBQWM7U0FDdkIsQ0FBQTtRQWNRLFdBQU0sR0FBRyxLQUFLLENBQUE7UUFDYixxQkFBZ0IsR0FBRyxJQUFJLFlBQVksRUFBYyxDQUFBO1FBWXpELEdBQUcsQ0FBQyxJQUFJLENBQ04sRUFBRSxFQUNGLFFBQVEsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksR0FBRyxhQUFhLEVBQ3hDLFFBQVEsQ0FDVCxDQUFBO1FBQ0QsR0FBRyxDQUFDLGVBQWUsR0FBRyxDQUFDLElBQWMsRUFBRSxFQUFFO1lBQ3ZDLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtRQUN2RCxDQUFDLENBQUE7SUFDSCxDQUFDO0lBRVEsUUFBUTtRQUNmLEtBQUssQ0FBQyxRQUFRLEVBQUUsQ0FBQTtRQUNoQixJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQTtRQUN0QyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFBO1FBQ3pCLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBTSxFQUFFLEVBQUU7WUFDOUIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEdBQUcsTUFBTSxDQUFBO1FBQ25ELENBQUMsQ0FBQyxDQUFBO1FBQ0YsSUFBSSxJQUFJLENBQUMsVUFBVSxFQUFFLGlCQUFpQixJQUFJLElBQUksQ0FBQyxVQUFVLEVBQUUsVUFBVSxFQUFFO1lBQ3JFLElBQUksQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQTtZQUN2QyxJQUFJLENBQUMsUUFBUSxHQUFHLE1BQU07aUJBQ25CLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRSxDQUFDLFlBQVksQ0FBQztpQkFDOUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRTtnQkFDakIsTUFBTSxJQUFJLEdBQUcsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO2dCQUNyQixPQUFPLElBQUksSUFBSSxJQUFJLENBQUMsUUFBUSxLQUFLLFNBQVMsSUFBSSxJQUFJLENBQUMsTUFBTSxLQUFLLFNBQVMsQ0FBQTtZQUN6RSxDQUFDLENBQUM7aUJBQ0QsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtZQUUxQyxPQUFNO1NBQ1Q7UUFDRCxJQUFJLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDakIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxxQkFBcUIsQ0FDNUIsRUFBRSxFQUNGLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsRUFDN0IsSUFBSSxDQUFDLE1BQU0sRUFDWCxLQUFLLENBQ04sQ0FBQTtTQUNGO0lBQ0gsQ0FBQztJQUVRLGVBQWU7UUFDdEIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFBO1FBQzVCLEtBQUssQ0FBQyxlQUFlLEVBQUUsQ0FBQTtRQUN2QixJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsYUFBYSxFQUFFLEVBQUUsaUJBQWlCO1lBQzdDLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQTtJQUNyQixDQUFDO0lBRUQsYUFBYTtRQUNYLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQTtJQUNqQixDQUFDO0lBRUQsS0FBSztRQUNILE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUE7SUFDdEIsQ0FBQztJQUVELFdBQVcsQ0FBQyxHQUFzQjtRQUNoQyxJQUFJLENBQUMsR0FBRyxDQUFDLG9CQUFvQixDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQTtRQUN6QyxVQUFVLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtJQUNuRixDQUFDO0lBRUQsWUFBWSxDQUFDLENBQTRDO1FBQ3ZELElBQUksQ0FBQyxHQUFHLENBQUMscUJBQXFCLENBQzVCLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUNsRCxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFDdEMsSUFBSSxDQUFDLE1BQU0sRUFDWCxJQUFJLEVBQ0osSUFBSSxJQUFJLEVBQUUsRUFDVixJQUFJLENBQUMsZ0JBQWdCLEVBQ3JCLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUMzQixDQUFBO0lBQ0gsQ0FBQztJQUVELFlBQVksQ0FBQyxLQUFVO1FBQ3JCLElBQUksQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFBO1FBQzFCLE1BQU0sT0FBTyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFBO1FBQ3RDLFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLEVBQUUsT0FBTyxDQUFDLENBQUE7SUFDOUMsQ0FBQztJQUVELFVBQVUsQ0FBQyxDQUFNO1FBQ2YsSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFBO1FBQ3hELElBQUksQ0FBQyxjQUFjLEdBQUcsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFBO1FBQzFDLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQTtJQUNuQixDQUFDO0lBRUQsVUFBVTtRQUNSLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxJQUFJLENBQUMsSUFBSSxDQUFDLGNBQWM7WUFDekMsT0FBTTtRQUVSLElBQUksRUFBRSxHQUE0QixTQUFTLENBQUE7UUFDM0MsS0FBSyxNQUFNLE1BQU0sSUFBSSxJQUFJLENBQUMsT0FBTyxFQUFFO1lBQ2pDLE1BQU0sR0FBRyxHQUFHLFFBQVEsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxLQUFLLENBQUMsQ0FBQTtZQUNqRixJQUFJLEdBQUcsSUFBSSxHQUFHLENBQUMsYUFBYSxFQUFFO2dCQUM1QixFQUFFLEdBQUcsR0FBRyxDQUFDLGFBQWEsQ0FBQTtnQkFDdEIsTUFBSzthQUNOO1NBQ0Y7UUFFRCxJQUFJLENBQUMsRUFBRTtZQUNMLE9BQU07UUFFUixNQUFNLFdBQVcsR0FBRyxFQUFFLENBQUMsV0FBVyxHQUFHLEVBQUUsQ0FBQTtRQUN2QyxNQUFNLFlBQVksR0FBRyxFQUFFLENBQUMsWUFBWSxHQUFHLEVBQUUsQ0FBQTtRQUN6QyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLFdBQVcsRUFBRSxZQUFZLENBQUMsQ0FBQTtJQUMxRCxDQUFDOzsrR0ExSlUsaUJBQWlCO21HQUFqQixpQkFBaUIsNlFBRmpCLENBQUMsd0JBQXdCLENBQUMseUpDaEJ2QyxpdkpBa0hBOzRGRGhHYSxpQkFBaUI7a0JBTjdCLFNBQVM7K0JBQ0UscUJBQXFCLGFBR3BCLENBQUMsd0JBQXdCLENBQUM7NlFBSTVCLElBQUk7c0JBQVosS0FBSztnQkFFRixRQUFRO3NCQURYLEtBQUs7Z0JBWUcsUUFBUTtzQkFBaEIsS0FBSztnQkFDRyxTQUFTO3NCQUFqQixLQUFLO2dCQUNJLGNBQWM7c0JBQXZCLE1BQU07Z0JBQ2lCLFNBQVM7c0JBQWhDLFNBQVM7dUJBQUMsV0FBVztnQkFTbEIsVUFBVTtzQkFEYixLQUFLO2dCQWFHLE1BQU07c0JBQWQsS0FBSztnQkFDSSxnQkFBZ0I7c0JBQXpCLE1BQU0iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBZnRlclZpZXdJbml0LCBDaGFuZ2VEZXRlY3RvclJlZiwgQ29tcG9uZW50LCBFbGVtZW50UmVmLCBFdmVudEVtaXR0ZXIsIElucHV0LCBOZ1pvbmUsIE91dHB1dCwgUmVuZGVyZXIyLCBWaWV3Q2hpbGQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEZpbHRlclNlcnZpY2UsIFByaW1lTkdDb25maWcgfSBmcm9tICdwcmltZW5nL2FwaSc7XG5pbXBvcnQgeyBEcm9wZG93biB9IGZyb20gJ3ByaW1lbmcvZHJvcGRvd24nO1xuaW1wb3J0IHsgTU9ERSB9IGZyb20gJy4uL2NvbnN0YW50cyc7XG5pbXBvcnQgeyBQcm92ZW5hbmNlV2lkZ2V0c1NlcnZpY2UsIFByb3ZlbmFuY2UgfSBmcm9tICcuLi9wcm92ZW5hbmNlLXdpZGdldHMuc2VydmljZSc7XG5pbXBvcnQgaXNFcXVhbCBmcm9tICdsb2Rhc2guaXNlcXVhbCc7XG5cbmludGVyZmFjZSBEcm9wZG93bkNoYW5nZUV2ZW50PFQ+IHtcbiAgb3JpZ2luYWxFdmVudDogRXZlbnQ7XG4gIHZhbHVlOiBUO1xufVxuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdwcm92ZW5hbmNlLWRyb3Bkb3duJyxcbiAgdGVtcGxhdGVVcmw6ICcuL2Ryb3Bkb3duLmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmxzOiBbJy4vZHJvcGRvd24uY29tcG9uZW50LnNjc3MnLCAnLi4vc2xpZGVyL3NsaWRlci5jb21wb25lbnQuc2NzcyddLFxuICBwcm92aWRlcnM6IFtQcm92ZW5hbmNlV2lkZ2V0c1NlcnZpY2VdXG59KVxuZXhwb3J0IGNsYXNzIERyb3Bkb3duQ29tcG9uZW50IGV4dGVuZHMgRHJvcGRvd24gaW1wbGVtZW50cyBBZnRlclZpZXdJbml0IHtcbiAgZmlyc3RDaGFuZ2UgPSB0cnVlXG4gIEBJbnB1dCgpIG1vZGUgPSBNT0RFXG4gIEBJbnB1dCgpXG4gIGdldCBzZWxlY3RlZCgpIHtcbiAgICByZXR1cm4gdGhpcy5fc2VsZWN0ZWRcbiAgfVxuICBzZXQgc2VsZWN0ZWQodmFsdWUpIHtcbiAgICBpZiAoIXRoaXMuZmlyc3RDaGFuZ2UgJiYgIWlzRXF1YWwodGhpcy5fc2VsZWN0ZWQsIHZhbHVlKSkge1xuICAgICAgdGhpcy5oYW5kbGVDaGFuZ2UoeyBvcmlnaW5hbEV2ZW50OiBuZXcgRXZlbnQoXCJwcm92ZW5hbmNlXCIpLCB2YWx1ZSB9KVxuICAgIH1cbiAgICB0aGlzLmZpcnN0Q2hhbmdlID0gZmFsc2VcbiAgICB0aGlzLl9zZWxlY3RlZCA9IHZhbHVlXG4gIH1cbiAgX3NlbGVjdGVkPzogdHlwZW9mIHRoaXMub3B0aW9uc1swXVxuICBASW5wdXQoKSBpY29uU2l6ZT86IG51bWJlclxuICBASW5wdXQoKSB2aXN1YWxpemUgPSB0cnVlXG4gIEBPdXRwdXQoKSBzZWxlY3RlZENoYW5nZSA9IG5ldyBFdmVudEVtaXR0ZXI8dHlwZW9mIHRoaXMub3B0aW9uc1swXT4oKVxuICBAVmlld0NoaWxkKFwicERyb3Bkb3duXCIpIHBEcm9wZG93biE6IERyb3Bkb3duXG4gIGludGVydmFsID0gTmFOXG4gIG9wdGlvbnNSZWNvcmQ6IFJlY29yZDxzdHJpbmcsIHR5cGVvZiB0aGlzLm9wdGlvbnNbMF0+ID0ge31cbiAgbXlPdmVybGF5T3B0aW9ucyA9IHtcbiAgICAnYXBwZW5kVG8nOiAnYm9keScgYXMgY29uc3QsXG4gICAgaGlkZU9uRXNjYXBlOiBmYWxzZSwgXG4gICAgLi4udGhpcy5vdmVybGF5T3B0aW9uc1xuICB9XG4gIEBJbnB1dCgpIFxuICBnZXQgcHJvdmVuYW5jZSgpIHtcbiAgICByZXR1cm4gdGhpcy5fcHJvdmVuYW5jZVxuICB9XG4gIHNldCBwcm92ZW5hbmNlKHZhbHVlKSB7XG4gICAgaWYgKHRoaXMuX3Byb3ZlbmFuY2UgJiYgdmFsdWU/LnJldmFsaWRhdGUpIHtcbiAgICAgIHRoaXMuX3Byb3ZlbmFuY2UgPSB2YWx1ZVxuICAgICAgdGhpcy5uZ09uSW5pdCgpXG4gICAgICB0aGlzLl92aXN1YWxpemUoKVxuICAgIH1cbiAgICB0aGlzLl9wcm92ZW5hbmNlID0gdmFsdWVcbiAgfVxuICBfcHJvdmVuYW5jZT86IFByb3ZlbmFuY2VcbiAgQElucHV0KCkgZnJlZXplID0gZmFsc2VcbiAgQE91dHB1dCgpIHByb3ZlbmFuY2VDaGFuZ2UgPSBuZXcgRXZlbnRFbWl0dGVyPFByb3ZlbmFuY2U+KClcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIG1zczogUHJvdmVuYW5jZVdpZGdldHNTZXJ2aWNlLFxuICAgIGVsOiBFbGVtZW50UmVmPGFueT4sXG4gICAgcmVuZGVyZXI6IFJlbmRlcmVyMixcbiAgICBjZDogQ2hhbmdlRGV0ZWN0b3JSZWYsXG4gICAgem9uZTogTmdab25lLFxuICAgIGZpbHRlclNlcnZpY2U6IEZpbHRlclNlcnZpY2UsXG4gICAgY29uZmlnOiBQcmltZU5HQ29uZmlnXG4gICkge1xuICAgIHN1cGVyKGVsLCByZW5kZXJlciwgY2QsIHpvbmUsIGZpbHRlclNlcnZpY2UsIGNvbmZpZylcbiAgICBtc3MuaW5pdChcbiAgICAgIGVsLFxuICAgICAgXCIucGFuZWxcIiArIHRoaXMubXNzLm15SWQgKyBcIiA+IGRpdiA+IHVsXCIsXG4gICAgICBcInNlbGVjdFwiXG4gICAgKVxuICAgIG1zcy5jcm9zc2hhaXJTZWxlY3QgPSAoa2V5czogc3RyaW5nW10pID0+IHtcbiAgICAgIHRoaXMuc2VsZWN0ZWRDaGFuZ2UuZW1pdCh0aGlzLm9wdGlvbnNSZWNvcmRba2V5c1swXV0pXG4gICAgfVxuICB9XG5cbiAgb3ZlcnJpZGUgbmdPbkluaXQoKTogdm9pZCB7XG4gICAgc3VwZXIubmdPbkluaXQoKVxuICAgIHRoaXMubXNzLm9wdGlvbnMgPSB0aGlzLm9wdGlvbnMubGVuZ3RoXG4gICAgdGhpcy5tc3MubW9kZSA9IHRoaXMubW9kZVxuICAgIHRoaXMub3B0aW9ucy5mb3JFYWNoKChvcHRpb24pID0+IHtcbiAgICAgIHRoaXMub3B0aW9uc1JlY29yZFtvcHRpb25bdGhpcy5kYXRhS2V5XV0gPSBvcHRpb25cbiAgICB9KVxuICAgIGlmICh0aGlzLnByb3ZlbmFuY2U/Lmhhc1VzZXJJbnRlcmFjdGVkIHx8IHRoaXMucHJvdmVuYW5jZT8ucmV2YWxpZGF0ZSkge1xuICAgICAgdGhpcy5tc3Muc2V0UHJvdmVuYW5jZSh0aGlzLnByb3ZlbmFuY2UpXG4gICAgICB0aGlzLnNlbGVjdGVkID0gT2JqZWN0XG4gICAgICAgIC5lbnRyaWVzKHRoaXMubXNzLmdldFByb3ZlbmFuY2UoKS5kYXRhQnlPcHRpb24pXG4gICAgICAgIC5maWx0ZXIoKFtfLCB2XSkgPT4ge1xuICAgICAgICAgIGNvbnN0IGxhc3QgPSB2LmF0KC0xKVxuICAgICAgICAgIHJldHVybiBsYXN0ICYmIGxhc3QudW5zZWxlY3QgPT09IHVuZGVmaW5lZCAmJiBsYXN0LnNlbGVjdCAhPT0gdW5kZWZpbmVkXG4gICAgICAgIH0pXG4gICAgICAgIC5tYXAoKFtrLCBfXSkgPT4gdGhpcy5vcHRpb25zUmVjb3JkW2tdKVswXVxuXG4gICAgICAgIHJldHVyblxuICAgIH1cbiAgICBpZiAodGhpcy5zZWxlY3RlZCkge1xuICAgICAgdGhpcy5tc3MuYWRkU2ltdWx0YW5lb3VzRXZlbnRzKFxuICAgICAgICBbXSxcbiAgICAgICAgW3RoaXMuc2VsZWN0ZWRbdGhpcy5kYXRhS2V5XV0sXG4gICAgICAgIHRoaXMuZnJlZXplLFxuICAgICAgICBmYWxzZVxuICAgICAgKVxuICAgIH1cbiAgfVxuXG4gIG92ZXJyaWRlIG5nQWZ0ZXJWaWV3SW5pdCgpOiB2b2lkIHtcbiAgICB0aGlzLm1zcy5zZXRFbGVtZW50KHRoaXMuZWwpXG4gICAgc3VwZXIubmdBZnRlclZpZXdJbml0KClcbiAgICBpZiAodGhpcy5tc3MuZ2V0UHJvdmVuYW5jZSgpPy5oYXNVc2VySW50ZXJhY3RlZClcbiAgICAgIHRoaXMuX3Zpc3VhbGl6ZSgpXG4gIH1cblxuICBnZXRQcm92ZW5hbmNlKCkge1xuICAgIHJldHVybiB0aGlzLm1zc1xuICB9XG5cbiAgZ2V0SWQoKSB7XG4gICAgcmV0dXJuIHRoaXMubXNzLm15SWRcbiAgfVxuXG4gIGhhbmRsZUNsaWNrKGJ0bjogSFRNTEJ1dHRvbkVsZW1lbnQpIHtcbiAgICB0aGlzLm1zcy50b2dnbGVQcm92ZW5hbmNlTW9kZShidG4sIGZhbHNlKVxuICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5wRHJvcGRvd24uc2hvdygpLCB0aGlzLnBEcm9wZG93bi5vdmVybGF5VmlzaWJsZSA/IDEwMDAgOiAwKVxuICB9XG5cbiAgaGFuZGxlQ2hhbmdlKGU6IERyb3Bkb3duQ2hhbmdlRXZlbnQ8dHlwZW9mIHRoaXMuc2VsZWN0ZWQ+KSB7XG4gICAgdGhpcy5tc3MuYWRkU2ltdWx0YW5lb3VzRXZlbnRzKFxuICAgICAgdGhpcy5zZWxlY3RlZCA/IFt0aGlzLnNlbGVjdGVkW3RoaXMuZGF0YUtleV1dIDogW10sXG4gICAgICBlLnZhbHVlID8gW2UudmFsdWVbdGhpcy5kYXRhS2V5XV0gOiBbXSxcbiAgICAgIHRoaXMuZnJlZXplLFxuICAgICAgdHJ1ZSxcbiAgICAgIG5ldyBEYXRlKCksXG4gICAgICB0aGlzLnByb3ZlbmFuY2VDaGFuZ2UsXG4gICAgICB0aGlzLl92aXN1YWxpemUuYmluZCh0aGlzKVxuICAgIClcbiAgfVxuXG4gIGhhbmRsZUZpbHRlcihldmVudDogYW55KSB7XG4gICAgdGhpcy5vbkZpbHRlcj8uZW1pdChldmVudClcbiAgICBjb25zdCB0aW1lb3V0ID0gZXZlbnQuZmlsdGVyID8gMCA6IDEwMFxuICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fdmlzdWFsaXplKCksIHRpbWVvdXQpXG4gIH1cblxuICB0b2dnbGVTaG93KGU6IGFueSkge1xuICAgIHRoaXNbdGhpcy5vdmVybGF5VmlzaWJsZSA/ICdvbkhpZGUnIDogJ29uU2hvdyddPy5lbWl0KGUpXG4gICAgdGhpcy5vdmVybGF5VmlzaWJsZSA9ICF0aGlzLm92ZXJsYXlWaXNpYmxlXG4gICAgdGhpcy5fdmlzdWFsaXplKClcbiAgfVxuXG4gIF92aXN1YWxpemUoKSB7XG4gICAgaWYgKCF0aGlzLnZpc3VhbGl6ZSB8fCAhdGhpcy5vdmVybGF5VmlzaWJsZSlcbiAgICAgIHJldHVyblxuXG4gICAgbGV0IGxpOiBIVE1MRWxlbWVudCB8IHVuZGVmaW5lZCA9IHVuZGVmaW5lZFxuICAgIGZvciAoY29uc3Qgb3B0aW9uIG9mIHRoaXMub3B0aW9ucykge1xuICAgICAgY29uc3QgZGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodGhpcy5tc3MubXlJZCArIG9wdGlvblt0aGlzLmRhdGFLZXldICsgJ2RpdicpXG4gICAgICBpZiAoZGl2ICYmIGRpdi5wYXJlbnRFbGVtZW50KSB7XG4gICAgICAgIGxpID0gZGl2LnBhcmVudEVsZW1lbnRcbiAgICAgICAgYnJlYWtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoIWxpKVxuICAgICAgcmV0dXJuXG5cbiAgICBjb25zdCBvZmZzZXRXaWR0aCA9IGxpLm9mZnNldFdpZHRoIC0gNDBcbiAgICBjb25zdCBvZmZzZXRIZWlnaHQgPSBsaS5vZmZzZXRIZWlnaHQgLSAyNFxuICAgIHRoaXMubXNzLnZpc3VhbGl6ZSh0aGlzLm1vZGUsIG9mZnNldFdpZHRoLCBvZmZzZXRIZWlnaHQpXG4gIH1cbn1cbiIsIjxkaXYgY2xhc3M9XCJwLWlucHV0Z3JvdXAgZmxleCBmbGV4LXJvdyBnYXAtM1wiPlxuICAgIDxidXR0b25cbiAgICAgICAgKm5nSWY9XCJ2aXN1YWxpemVcIlxuICAgICAgICBwQnV0dG9uXG4gICAgICAgIHR5cGU9XCJidXR0b25cIlxuICAgICAgICBjbGFzcz1cInAtYnV0dG9uLWhlbHAgcC1idXR0b24tdGV4dFwiXG4gICAgICAgIFtkaXNhYmxlZF09XCIhZ2V0UHJvdmVuYW5jZSgpLmhhc1VzZXJJbnRlcmFjdGVkXCJcbiAgICAgICAgW25nU3R5bGVdPVwieyAncGFkZGluZyc6IDAsICdhbGlnbi1zZWxmJzogJ2NlbnRlcicsICdoZWlnaHQnOiAnbWluLWNvbnRlbnQnLCAndmlzaWJpbGl0eSc6IHZpc3VhbGl6ZSA/ICd2aXNpYmxlJyA6ICdoaWRkZW4nfVwiXG4gICAgICAgICNidG5cbiAgICAgICAgKGNsaWNrKT1cImhhbmRsZUNsaWNrKGJ0bilcIlxuICAgID5cbiAgICAgICAgPHByb3ZlbmFuY2UtaWNvblxuICAgICAgICAgICAgW2ljb25dPVwiIWdldFByb3ZlbmFuY2UoKS5oYXNVc2VySW50ZXJhY3RlZCA/ICdkaXNhYmxlZCcgOiBnZXRQcm92ZW5hbmNlKCkucHJvdmVuYW5jZU1vZGVcIlxuICAgICAgICAgICAgW3NpemVdPVwiaWNvblNpemVcIlxuICAgICAgICA+PC9wcm92ZW5hbmNlLWljb24+XG4gICAgPC9idXR0b24+XG4gICAgPHAtZHJvcGRvd25cbiAgICAgICAgI3BEcm9wZG93blxuICAgICAgICBbc2Nyb2xsSGVpZ2h0XT1cInNjcm9sbEhlaWdodFwiXG4gICAgICAgIFtmaWx0ZXJdPVwiZmlsdGVyXCJcbiAgICAgICAgW25hbWVdPVwibmFtZVwiXG4gICAgICAgIFtzdHlsZV09XCJzdHlsZVwiXG4gICAgICAgIFtwYW5lbFN0eWxlXT1cInBhbmVsU3R5bGVcIlxuICAgICAgICBbc3R5bGVDbGFzc109XCIoc3R5bGVDbGFzcyB8fCAnJykgKyAnIHByb3ZlbmFuY2UtZHJvcGRvd24nXCJcbiAgICAgICAgW3BhbmVsU3R5bGVDbGFzc109XCIocGFuZWxTdHlsZUNsYXNzIHx8ICcnKSArICdwcm92ZW5hbmNlLWRyb3Bkb3duLXBhbmVsIHBhbmVsJyArIHRoaXMuZ2V0SWQoKVwiXG4gICAgICAgIFtyZWFkb25seV09XCJyZWFkb25seVwiXG4gICAgICAgIFtyZXF1aXJlZF09XCJyZXF1aXJlZFwiXG4gICAgICAgIFtlZGl0YWJsZV09XCJlZGl0YWJsZVwiXG4gICAgICAgIFthcHBlbmRUb109XCJhcHBlbmRUb1wiXG4gICAgICAgIFt0YWJpbmRleF09XCJ0YWJpbmRleFwiXG4gICAgICAgIFtwbGFjZWhvbGRlcl09XCJwbGFjZWhvbGRlclwiXG4gICAgICAgIFtmaWx0ZXJQbGFjZWhvbGRlcl09XCJmaWx0ZXJQbGFjZWhvbGRlclwiXG4gICAgICAgIFtmaWx0ZXJMb2NhbGVdPVwiZmlsdGVyTG9jYWxlXCJcbiAgICAgICAgW2lucHV0SWRdPVwiaW5wdXRJZFwiXG4gICAgICAgIFtzZWxlY3RJZF09XCJzZWxlY3RJZFwiXG4gICAgICAgIFtkYXRhS2V5XT1cImRhdGFLZXlcIlxuICAgICAgICBbZmlsdGVyQnldPVwiZmlsdGVyQnlcIlxuICAgICAgICBbYXV0b2ZvY3VzXT1cImF1dG9mb2N1c1wiXG4gICAgICAgIFtyZXNldEZpbHRlck9uSGlkZV09XCJyZXNldEZpbHRlck9uSGlkZVwiXG4gICAgICAgIFtkcm9wZG93bkljb25dPVwiZHJvcGRvd25JY29uXCJcbiAgICAgICAgW29wdGlvbkxhYmVsXT1cIm9wdGlvbkxhYmVsXCJcbiAgICAgICAgW29wdGlvblZhbHVlXT1cIm9wdGlvblZhbHVlXCJcbiAgICAgICAgW29wdGlvbkRpc2FibGVkXT1cIm9wdGlvbkRpc2FibGVkXCJcbiAgICAgICAgW29wdGlvbkdyb3VwTGFiZWxdPVwib3B0aW9uR3JvdXBMYWJlbFwiXG4gICAgICAgIFtvcHRpb25Hcm91cENoaWxkcmVuXT1cIm9wdGlvbkdyb3VwQ2hpbGRyZW5cIlxuICAgICAgICBbYXV0b0Rpc3BsYXlGaXJzdF09XCJhdXRvRGlzcGxheUZpcnN0XCJcbiAgICAgICAgW2dyb3VwXT1cImdyb3VwXCJcbiAgICAgICAgW3Nob3dDbGVhcl09XCJzaG93Q2xlYXJcIlxuICAgICAgICBbZW1wdHlGaWx0ZXJNZXNzYWdlXT1cImVtcHR5RmlsdGVyTWVzc2FnZVwiXG4gICAgICAgIFtlbXB0eU1lc3NhZ2VdPVwiZW1wdHlNZXNzYWdlXCJcbiAgICAgICAgW2xhenldPVwibGF6eVwiXG4gICAgICAgIFt2aXJ0dWFsU2Nyb2xsXT1cInZpcnR1YWxTY3JvbGxcIlxuICAgICAgICBbdmlydHVhbFNjcm9sbEl0ZW1TaXplXT1cInZpcnR1YWxTY3JvbGxJdGVtU2l6ZVwiXG4gICAgICAgIFt2aXJ0dWFsU2Nyb2xsT3B0aW9uc109XCJ2aXJ0dWFsU2Nyb2xsT3B0aW9uc1wiXG4gICAgICAgIFtvdmVybGF5T3B0aW9uc109XCJteU92ZXJsYXlPcHRpb25zXCJcbiAgICAgICAgW2FyaWFGaWx0ZXJMYWJlbF09XCJhcmlhRmlsdGVyTGFiZWxcIlxuICAgICAgICBbYXJpYUxhYmVsXT1cImFyaWFMYWJlbFwiXG4gICAgICAgIFthcmlhTGFiZWxsZWRCeV09XCJhcmlhTGFiZWxsZWRCeVwiXG4gICAgICAgIFtmaWx0ZXJNYXRjaE1vZGVdPVwiZmlsdGVyTWF0Y2hNb2RlXCJcbiAgICAgICAgW21heGxlbmd0aF09XCJtYXhsZW5ndGhcIlxuICAgICAgICBbdG9vbHRpcF09XCJ0b29sdGlwXCJcbiAgICAgICAgW3Rvb2x0aXBQb3NpdGlvbl09XCJ0b29sdGlwUG9zaXRpb25cIlxuICAgICAgICBbdG9vbHRpcFBvc2l0aW9uU3R5bGVdPVwidG9vbHRpcFBvc2l0aW9uU3R5bGVcIlxuICAgICAgICBbdG9vbHRpcFN0eWxlQ2xhc3NdPVwidG9vbHRpcFN0eWxlQ2xhc3NcIlxuICAgICAgICBbYXV0b2ZvY3VzRmlsdGVyXT1cImF1dG9mb2N1c0ZpbHRlclwiXG4gICAgICAgIFtvdmVybGF5RGlyZWN0aW9uXT1cIm92ZXJsYXlEaXJlY3Rpb25cIlxuICAgICAgICBbZGlzYWJsZWRdPVwiZGlzYWJsZWRcIlxuICAgICAgICBbaXRlbVNpemVdPVwiaXRlbVNpemVcIlxuICAgICAgICBbYXV0b1pJbmRleF09XCJhdXRvWkluZGV4XCJcbiAgICAgICAgW2Jhc2VaSW5kZXhdPVwiYmFzZVpJbmRleFwiXG4gICAgICAgIFtzaG93VHJhbnNpdGlvbk9wdGlvbnNdPVwic2hvd1RyYW5zaXRpb25PcHRpb25zXCJcbiAgICAgICAgW2hpZGVUcmFuc2l0aW9uT3B0aW9uc109XCJoaWRlVHJhbnNpdGlvbk9wdGlvbnNcIlxuICAgICAgICBbb3B0aW9uc109XCJvcHRpb25zXCJcbiAgICAgICAgW2ZpbHRlclZhbHVlXT1cImZpbHRlclZhbHVlXCJcbiAgICAgICAgKG9uQ2hhbmdlKT1cIm9uQ2hhbmdlXCJcbiAgICAgICAgKG9uRmlsdGVyKT1cImhhbmRsZUZpbHRlcigkZXZlbnQpXCJcbiAgICAgICAgKG9uRm9jdXMpPVwib25Gb2N1c1wiXG4gICAgICAgIChvbkJsdXIpPVwib25CbHVyXCJcbiAgICAgICAgKG9uQ2xpY2spPVwib25DbGlja1wiXG4gICAgICAgIChvblNob3cpPVwidG9nZ2xlU2hvdygkZXZlbnQpXCJcbiAgICAgICAgKG9uSGlkZSk9XCJ0b2dnbGVTaG93KCRldmVudClcIlxuICAgICAgICAob25DbGVhcik9XCJvbkNsZWFyXCJcbiAgICAgICAgKG9uTGF6eUxvYWQpPVwib25MYXp5TG9hZFwiXG4gICAgICAgIChuZ01vZGVsQ2hhbmdlKT1cInRoaXMuZ2V0UHJvdmVuYW5jZSgpLmludGVyYWN0aW9uID0gJ3VzZXItY2hhbmdlJzsgc2VsZWN0ZWRDaGFuZ2UuZW1pdCgkZXZlbnQpXCJcbiAgICAgICAgW25nTW9kZWxdPVwic2VsZWN0ZWRcIlxuICAgID5cbiAgICAgICAgPG5nLXRlbXBsYXRlIGxldC1vcHRpb24gcFRlbXBsYXRlPVwiaXRlbVwiPlxuICAgICAgICAgICAgPGRpdiBzdHlsZT1cInBvc2l0aW9uOiByZWxhdGl2ZTsgd2lkdGg6IDEwMCU7XCIgW2lkXT1cImdldElkKCkgKyBvcHRpb25bZGF0YUtleV0gKyAnZGl2J1wiPlxuICAgICAgICAgICAgICAgIDxzdmcgXG4gICAgICAgICAgICAgICAgICBbaWRdPVwiZ2V0SWQoKSArIG9wdGlvbltkYXRhS2V5XVwiIFxuICAgICAgICAgICAgICAgICAgd2lkdGg9XCIwXCIgXG4gICAgICAgICAgICAgICAgICBoZWlnaHQ9XCIwXCJcbiAgICAgICAgICAgICAgICAgIFtzdHlsZV09XCJ7ICdwb3NpdGlvbic6ICdhYnNvbHV0ZScsICdkaXNwbGF5JzogZ2V0UHJvdmVuYW5jZSgpLmhhc1VzZXJJbnRlcmFjdGVkID8gJ2luaXRpYWwnIDogJ25vbmUnIH1cIlxuICAgICAgICAgICAgICAgID48L3N2Zz5cbiAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPVwiZGlzcGxheTogZmxleDsganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOyBwb3NpdGlvbjogaW5oZXJpdDtcIj5cbiAgICAgICAgICAgICAgICAgICAgPHNwYW4+XG4gICAgICAgICAgICAgICAgICAgICAgICB7eyBvcHRpb25bb3B0aW9uTGFiZWxdIH19XG4gICAgICAgICAgICAgICAgICAgIDwvc3Bhbj5cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICA8L25nLXRlbXBsYXRlPlxuICAgICAgICA8bmctdGVtcGxhdGUgcFRlbXBsYXRlPVwiZm9vdGVyXCI+XG4gICAgICAgICAgICA8ZGl2IGNsYXNzPVwiY3VzdG9tLXNsaWRlciB0ZW1wb3JhbC1zbGlkZXJcIj5cbiAgICAgICAgICAgICAgICA8bmd4LXNsaWRlclxuICAgICAgICAgICAgICAgICAgICAqbmdJZj1cImdldFByb3ZlbmFuY2UoKS5wcm92ZW5hbmNlTW9kZSA9PT0gJ3RlbXBvcmFsJ1wiXG4gICAgICAgICAgICAgICAgICAgIFt2YWx1ZV09XCJnZXRQcm92ZW5hbmNlKCkudGVtcG9yYWxGaWx0ZXJSYW5nZVswXVwiXG4gICAgICAgICAgICAgICAgICAgIFtoaWdoVmFsdWVdPVwiZ2V0UHJvdmVuYW5jZSgpLnRlbXBvcmFsRmlsdGVyUmFuZ2VbMV1cIlxuICAgICAgICAgICAgICAgICAgICBbb3B0aW9uc109XCJnZXRQcm92ZW5hbmNlKCkudGVtcG9yYWxPcHRpb25zXCJcbiAgICAgICAgICAgICAgICAgICAgKHVzZXJDaGFuZ2VFbmQpPVwiZ2V0UHJvdmVuYW5jZSgpLnNldFRlbXBvcmFsUmFuZ2UoJGV2ZW50KVwiXG4gICAgICAgICAgICAgICAgPjwvbmd4LXNsaWRlcj5cbiAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICA8L25nLXRlbXBsYXRlPlxuICAgIDwvcC1kcm9wZG93bj5cbjwvZGl2PlxuIl19